<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC1Fuqax5sLGDq4KRkjaTobvhq-y-UyNVA"></script>
    <script>

        var imageSup = 'iconSup3.png';
        var imagePat = 'iconPat4.png';
        
        var patients = [];
        var supps= [];
        
        function onCooRecieved2(){
        
        network = [];
        
        for(var i = 0; i<patients.length; i++){
            network.push({patient: patients[i].code, support: [] });
            
            for(var j = 0; j<supps.length; j++){
                if(patients[i].name == supps[j].pat){
                    network[i].support.push(supps[j].code);
                }
            }
        }
        
            
            var Glasgow = {lat: 55.852749, lng: -4.2209248};
    
            var map = new google.maps.Map(document.getElementById('map'), {
                center: Glasgow,
                zoom: 12
            });
        
        
        
            for(var i = 0; i<network.length; i++){
            
                var source = network[i].patient;
            
                var marker = new google.maps.Marker({
                    position: source,
                    map: map,
                    mapTypeId: google.maps.MapTypeId.TERRAIN,
                    icon: imagePat
                });
            
            
                var supporters = network[i].support;
                
                for(var j = 0; j<supporters.length; j++){
                
                    
                
                    var marker = new google.maps.Marker({
                        position: supporters[j],
                        map: map,
                        mapTypeId: google.maps.MapTypeId.TERRAIN,
                        icon: imageSup
                    });
                    
                   
                    
                    var paths = [supporters[j], source];
                
                    var flightPath = new google.maps.Polyline({
                        path: paths,
                        geodesic: true,
                        strokeColor: '#855081',
                        strokeOpacity: 1.0,
                        strokeWeight: 2
                    });

                    flightPath.setMap(map);
                    
                }
            }      
        }
        
        
        function onCooRecieved(){
        
            var m = supps.length;
            for(var i = 0; i<supps.length; i++){

                supps[i] = {name: supps[i].title, code: supps[i].meta.post_code, pat: supps[i].meta.member.post_title};
                
                var apiUrl = "http://maps.googleapis.com/maps/api/geocode/json?address=" + supps[i].code + "&sensor=false";
                jQuery.getJSON( apiUrl, function( i, data ) {
                    m--;
                    supps[i].code = data.results[0].geometry.location;
                    if(m == 0){
                        onCooRecieved2();
                    }
                }.bind(this, i));
                
            }                                     
        }
        
        
        function onDataRecieved(){
            
            var l = patients.length;
            
            for(var i = 0; i<patients.length; i++){
            
                patients[i] = {name: patients[i].title, code: patients[i].meta.post_code};
                
                var apiUrl = "http://maps.googleapis.com/maps/api/geocode/json?address=" + patients[i].code + "&sensor=false";
                jQuery.getJSON( apiUrl, function( i, data ) {
                    l--;
                    patients[i].code = data.results[0].geometry.location;
                    if(l == 0){
                        onCooRecieved();
                    }
                }.bind(this, i));
                
                       
            }     
        }
        
        
     
     
            
     jQuery.getJSON( "http://5c1223b5.ngrok.com/cancer/team-6/wp-json/posts?type=member", function( data ) {
        patients = data;
            
        jQuery.getJSON( "http://5c1223b5.ngrok.com/cancer/team-6/wp-json/posts?type=supporter", function( data ) {
            supps = data;
                
            onDataRecieved();
                
        });
            
    });
    
       

    </script>
    
    
  </body>
</html>